<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit">
	<script type="text/javascript">
	/* if(sessionStorage.isLogout){
		 window.history.replaceState(null,null,"")
		 window.location.replace("/login")
	} */
	
	if(sessionStorage.isLogout == 'false'){
		
	}else{
		 window.history.replaceState(null,null,"")
		 window.location.replace("/login")
	}
	
	</script>
    <title>银玺·生产线数据中心</title>

    <meta name="keywords" content="">
    <meta name="description" content="">
	
    <!--[if lt IE 8]>
    <script>
        alert('H+已不支持IE6-8，请使用谷歌、火狐等浏览器\n或360、QQ等国产浏览器的极速模式浏览本页面！');
    </script>
    <![endif]-->
    <link href="${base}css/plugins/ztree/zTreeStyle/zTreeStyle.css" rel="stylesheet">
	<link href="${base}img/favicon.ico" rel="shortcut icon">
    <link href="${base}css/bootstrap.min.css?v=3.4.0" rel="stylesheet">
    <link href="${base}css/font-awesome.min.css?v=4.3.0" rel="stylesheet">
    <link href="${base}css/animate.css" rel="stylesheet">
    <link href="${base}css/style.css" rel="stylesheet">
    <link href="${base}css/index.css" rel="stylesheet">
    <link href="${base}css/plugins/footable/footable.core.css" rel="stylesheet">
    <link href="${base}css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="${base}css/plugins/periodsPicker/periodsPicker.css" rel="stylesheet">
    <link href="${base}js/plugins/layui/css/layui.css" rel="stylesheet">
    <link href="${base}js/plugins/layer/laydate/theme/default/laydate.css" rel="stylesheet">
    <script src="${base}js/plugins/layer/laydate/laydate.js"></script>
    
    <link href="${base}css/plugins/chosen/chosen.css" rel="stylesheet">
    <link href="${base}css/plugins/steps/jquery.steps.css" rel="stylesheet">
    <link href="${base}css/plugins/switchery/switchery.css" rel="stylesheet">
    
</head>

<body class="fixed-sidebar full-height-layout gray-bg">
	<div class="fixed-loading" style="position: fixed;left: 0;top: 0;right: 0;bottom: 0;z-index:9999"></div>
	<#include "tpl/tpl.html"/>
	<#include "tpl/productionModeTpl.html"/>
    <div id="wrapper">
        <!--左侧导航开始-->
        <nav class="navbar-default navbar-static-side" role="navigation">
            <div class="nav-close"><i class="fa fa-times-circle"></i>
            </div>
            <div class="sidebar-collapse">
                <ul class="nav" id="side-menu">
                    <li class="nav-header">
                        <div class="dropdown profile-element text-center">
                            <span><img alt="image" class="img-circle" style="height:64px;width:64px;"
                            <#if user.sex??>
                            	<#if user.sex=="女">
                            	src="${base}img/profile_small.jpg" 
                            	<#else>
                            	src="${base}img/male.png"
                            	</#if>
                            <#else>
                            	src="${base}img/male.png"
                            </#if>
                            /></span>
                            <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                                <span class="clear">
                               <span class="block m-t-xs"><strong class="font-bold">
                              		${user.acount}
                               </strong></span>
                                <span class="text-muted text-xs block"><#if user.dept??>${user.dept.name!''}</#if></span>
                                </span>
                            </a>
                        </div>
                        <div class="logo-element"><img src="img/logo.png" width="30" height="30"></div>
                    </li>
                    <li>
                        <a class="J_menuItem" href="start">
                            <i class="fa fa-bullhorn"></i> 
                            <span class="nav-label">主页</span>
                        </a>
                    </li>
                    <li>
                        <a class="J_menuItem" href="ecm">
                            <i class="fa fa-cube"></i> 
                            <span class="nav-label">主体管理</span>
                        </a>
                    </li>
                     <li>
                        <a href="#">
                            <i class="fa fa-diamond"></i>
                            <span class="nav-label">生产要素</span>
                            <span class="fa arrow"></span>
                        </a>
                        <ul class="nav nav-second-level">
                            <li><a class="J_menuItem" href="product">产品</a></li>
                            <li><a class="J_menuItem" href="productionLine">生产线</a></li>
                            <li><a class="J_menuItem" href="codingCenter">产品码规则</a></li>
                            <!-- <li><a class="J_menuItem" href="productCode">产品码</a></li> -->
                            <li><a class="J_menuItem" href="device">设备</a></li>
                            <li><a class="J_menuItem" href="ipc">工控机</a></li>
                            <li><a class="J_menuItem" href="shop">车间</a></li>
                            
                        </ul>
                    </li>
                    <li>
                        <a href="#">
                            <i class="fa fa-futbol-o"></i>
                            <span class="nav-label">发布要素</span>
                            <span class="fa arrow"></span>
                        </a>
                        <ul class="nav nav-second-level">
                            <li><a class="J_menuItem" href="productPrintPlan">打印方案</a></li>
                            <li><a class="J_menuItem" href="batch">批次管理</a></li>
                            <li><a class="J_menuItem" href="productionMode">生产模式</a></li>
                            <!-- <li><a class="J_menuItem" href="qrcodeExport">二维码导出</a></li> -->
                        </ul>
                    </li>
                    <li>
                        <a class="J_menuItem" href="user">
                            <i class="fa fa-user"></i> 
                            <span class="nav-label">用户管理</span>
                        </a>
                    </li>
                    <li>
                        <a class="J_menuItem" href="publicNotice">
                            <i class="fa fa-twitch"></i> 
                            <span class="nav-label">公告管理</span>
                        </a>
                    </li>
                     <li>
                        <a class="J_menuItem" href="systemConfig">
                            <i class="fa fa-cog"></i> 
                            <span class="nav-label">系统配置</span>
                        </a>
                    </li>
                   
                </ul>
            </div>
        </nav>
        <!--左侧导航结束-->

        <!--右侧部分开始-->
        <div id="page-wrapper" class="gray-bg dashbard-1">
            <div class="row border-bottom">
                <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0">
                    <div class="navbar-header">
                    	<a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i></a>
                    </div>
                    <ul class="nav navbar-top-links navbar-right">
	                    <li class="program-title">
	                    	<img src="img/logo-1.png" width="30" height="30">&nbsp;银玺·生产线数据中心
	                    </li>
	                    <li class="hidden-xs">
	                        <a class="logout" >登出&nbsp;<i class="fa fa-sign-out"></i></a>
	                    </li>
	                </ul>
                </nav>
               
            </div>
            <div class="row content-tabs">
                <button class="roll-nav roll-left J_tabLeft"><i class="fa fa-backward"></i>
                </button>
                <nav class="page-tabs J_menuTabs">
                    <div class="page-tabs-content">
                    </div>
                </nav>
                <button class="roll-nav roll-right J_tabRight" style="right:80px"><i class="fa fa-forward"></i></button>
                <div class="btn-group roll-nav roll-right" style="right:0">
                    <button class="dropdown J_tabClose"  data-toggle="dropdown">关闭&nbsp;<span class="caret"></span></button>
                    <ul role="menu" class="dropdown-menu dropdown-menu-right">
                        <li class="J_tabCloseAll"><a>关闭全部</a> </li>
                        <li class="divider"></li>
                        <li class="J_tabCloseOther"><a>关闭其他</a></li>
                    </ul>
                </div>   
            </div>
            <div class="row J_mainContent" id="content-main"></div>
            <div class="footer">
                <div class="pull-right">Copyright &copy; 2010-2015,www.emininfo.com,All rights reserved  蜀ICP备16033956号</div>
            </div>
        </div>
        <!--右侧部分结束-->
        <div id="right-sidebar" >
         <#include "releaseNotes.html">
        </div>
    </div>
	<div class="wrapper-content hide"  id="ecmCreateOrSycnSTEP">
	    <div class="row">
	    	<div class="col-sm-12 text-center tips">
	    		<i class="fa fa-circle text-danger">&nbsp;</i>亲爱的用户，当前您还没有任何企业信息，您可以选择新建一个企业或者同步已有的企业信息
	    	</div>
	    </div>
	    <div class="hr-line-dashed"></div>
	    <div class="row">
	    	<div class="col-sm-6" style="border-right: 1px solid #e7eaec">
   				<h3 class="m-t-none m-b text-center">新建企业</h3>
         		<div class="hr-line-dashed"></div>
   				<form method="get" class="form-horizontal createEcmForm">
                     <div class="form-group">
                         <label class="col-sm-3 text-center control-label">企业名称</label>
                         <div class="col-sm-8">
                    		<input class="form-control" type="text" name="name">
                         </div>
                     </div>
                     <div class="form-group">
                         <label class="col-sm-3 text-center control-label">所属行业</label>
                         <div class="col-sm-8">
                         	<input class="form-control" type="text" name="industry">
                         </div>
                     </div>
                     <div class="form-group">
                         <div class="col-sm-4 col-sm-offset-3">
                             <button class="btn btn-primary" type="submit">确定创建</button>
                         </div>
                     </div>
                 </form>
	    	</div>
	    	<div class="col-sm-6">
				<h3 class="m-t-none m-b text-center">同步已有企业</h3>
		    	<div class="hr-line-dashed"></div>
				<form method="get" class="form-horizontal sycnEcmForm" id="sycnEcmForm">
	                <!-- 
	                <div class="form-group">
	                    <label class="col-sm-3 text-center control-label">企业名称</label>
	                    <div class="col-sm-8">
	               			<input class="form-control" type="text" name="name">
	                    </div>
	                </div>
	                 -->
	                 <div class="form-group">
	                    <label class="col-sm-3 text-center control-label">企业代码</label>
	                    <div class="col-sm-8">
	               			<input class="form-control" type="text" name="companyCode">
	                    </div>
	                </div>
	                <div class="form-group">
	                    <div class="col-sm-4 col-sm-offset-3">
	                        <button class="btn btn-primary" type="submit">开始同步</button>
	                    </div>
	                </div>
	            </form>
	    	</div>
	    </div>
	</div>
    <!-- 全局js -->
    <script src="${base}js/jquery-2.1.1.min.js"></script>
    <script src="${base}js/bootstrap.min.js?v=3.4.0"></script>
    <script src="${base}js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="${base}js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
    <script src="${base}js/plugins/layer/layer.min.js"></script>
	<script src="${base}js/plugins/layui/layui.js" ></script>
	<script type="text/javascript">
		var base = "${base}";
	</script>
    <!-- 自定义js -->
    <script src="${base}js/hplus.js?v=3.2.0"></script>
    <script src="${base}js/contabs.js"></script>
    <script src="${base}js/emin/emin.ztree.js"></script>
    <script src="${base}js/emin/dataLoad.js"></script>
    <script src="${base}js/dataChosen.js"></script>

    <!-- 第三方插件 -->
    <script src="${base}js/plugins/pace/pace.min.js"></script>
    <script src="${base}js/plugins/footable/footable.all.min.js"></script>
    <script src="${base}js/plugins/validate/jquery.validate.min.js"></script>
    <script src="${base}js/plugins/validate/messages_zh.min.js"></script>
    <script src="${base}js/plugins/validate/compatible_bootstrap.js"></script>
    <script src="${base}js/plugins/validate/validate_method.js"></script>
    <script src="${base}js/plugins/iCheck/icheck.min.js"></script>
	<script src="${base}js/plugins/periodsPicker/periodsPicker.js" ></script>
    <!-- CHOSEN -->
    <script src="${base}js/plugins/chosen/chosen.jquery.js" ></script>
    <!-- Steps -->
    <script src="${base}js/plugins/steps/jquery.steps.min.js" ></script> 
    <!-- Switchery -->
    <script src="${base}js/plugins/switchery/switchery.js"></script>
    <!-- ztree -->
    <script src="${base}js/plugins/ztree/jquery.ztree.core.js"></script>
	<script src="${base}js/plugins/ztree/jquery.ztree.excheck.js"></script>
	<script src="${base}js/plugins/ztree/jquery.ztree.exedit.js"></script>
	
	<script type="text/javascript" src="${base}js/modules/product/common.js"></script>
	
	
	<script>
		var icon = "<i class='fa fa-times-circle'></i> ",
			loading = null,
			basePath = '${base}';
		
		function logout() {
			$.ajax({
				url:"${base}signout",
				type:"get",
				success:function(data){
					 window.history.replaceState(null,null,"")
					 sessionStorage.isLogout = true;
					 window.location.replace("/login")
				}
			})
		}
			
		$(".logout").click(function(){
			layer.confirm('是否确定注销登录？', {
			    btn: ['确定','取消']//按钮
			  //  shade: true //不显示遮罩
			}, function(){
				logout();
			}, function(){
			});
		})
		
		var loginAccount = '${user.acount}',
			ignoreTipsTime = localStorage.ignoreTipsTime,//忽略提醒的生效时间
			ignoreTipsDays = localStorage.ignoreTipsDays,//忽略提醒的设置天数
			ignoreIsUntil = true,//忽略提醒的设置是否到期
			ecmStepWindowId  = null,
			isExistEcm = parseInt('${existEcm}');
		
		if (ignoreTipsTime && ignoreTipsDays) {
			if (new Date().getTime() <= (parseInt(ignoreTipsTime) + (parseInt(ignoreTipsDays)*24*60*60*1000))) {
				ignoreIsUntil = false;
			}
			
		}
		//如果存在主体，将主体信息获取到保存为全局变量
		if (isExistEcm) {
			localStorage.ecm = '${ecm!''}';
			localStorage.removeItem('ignoreTipsTime');
			localStorage.removeItem('ignoreTipsDays');
		}
		//判断当前登录用户是超级管理员，并且忽略提醒的设置到期，则打开主体信息缺失提示
		if (!isExistEcm && loginAccount == 'admin' && ignoreIsUntil) {
			$('#ecmCreateOrSycnSTEP').removeClass('hide');
			ecmStepWindowId = layer.open({
			  type: 1,
			  shade: [0.5, '#000'],
			  area: ['60%', '360px'],
			  title: false, //不显示标题
			  content: $('#ecmCreateOrSycnSTEP'), //捕获的元素，注意：最好该指定的元素要存放在body最外层，否则可能被其它的相对元素所影响
			});
			$('#ecmCreateOrSycnSTEP .tips').append('<a href="javascript: ignoreEcmTips()">一周内不再提醒</a>')
			ecmStepValidateInit ('#ecmCreateOrSycnSTEP');
		
		}
		/**
		 * 一周内不再提醒
		 */
		function ignoreEcmTips(){
			localStorage.ignoreTipsTime = new Date().getTime();
			localStorage.ignoreTipsDays = 7;
			layer.close(ecmStepWindowId);
			
		}

		/**
		 * 主体步骤验证初始化
		 */
		function ecmStepValidateInit(wrapId) {
			//同步主体表单验证及提交
			var $sycnformEl = $(wrapId + ' .sycnEcmForm');
			$sycnformEl.validate({
			    rules: {
		            companyCode: {
		                required: true,
		                rangelength: [15,20],
		                isRightfulString: true
		            }
			    },
			    messages: {
		            companyCode: {
		                required: icon + "请输入企业编号",
		                rangelength: icon + "企业编号输入长度限制为15-20个合法字符"
		            }
			    },
			    submitHandler:function(form){
			    	var submitObj = $sycnformEl.serializeObject();
			    	loading = layer.load();
			    	$.ajax({
			        	url: basePath + 'ecm/synEcm',
			        	data: submitObj,
			        	type: "post",
			        	success:function(data){
			        		layer.close(loading);
			        		if (!data.success){
			        			layer.msg(data.message ? data.message : '同步失败！', {icon: 5});
			        		} else {
			        			layer.msg('信息同步成功！', {icon: 6});
			        			localStorage.removeItem('ignoreTipsTime');
			        			localStorage.removeItem('ignoreTipsDays');
			        			if (ecmStepWindowId) {
				        			layer.close(ecmStepWindowId);
			        			} else {
				        			goPage('index');
			        			}
			        		}
			        	}
			        });	
			    } 
			});

			//创建主体表单验证及提交
			var $addformEl = $(wrapId + ' .createEcmForm');
			$addformEl.validate({
			    rules: {
		        	name: {
		                required: true,
		                rangelength: [2,30],
		                isContainsSpecialChar: true
		            },
			        industry: {
			            required: true,
			            rangelength: [2,10],
		                isContainsSpecialChar: true
			        }
			    },
			    messages: {
		        	name: {
		                required: icon + "请输入企业名称",
		                rangelength: icon + "企业名称输入长度限制为2-30个合法字符"
		            },
			        industry: {
			            required: icon + "请填写所属行业",
			            rangelength: icon + "所属行业输入长度必须介于2和10之间"
			        }
			    },
			    submitHandler:function(form){
			    	var submitObj = $addformEl.serializeObject();
			    	
			    	loading = layer.load();
			    	$.ajax({
			        	url: basePath + 'ecm/saveEcm',
			        	data: submitObj,
			        	type: "post",
			        	success:function(data){
			        		layer.close(loading);
			        		if (!data.success){
			        			layer.msg(data.message ? data.message : '创建失败！', {icon: 5});
			        		} else {
			        			localStorage.removeItem('ignoreTipsTime');
			        			localStorage.removeItem('ignoreTipsDays');
			        			if (ecmStepWindowId) {
				        			layer.msg('您已成功的创建了企业信息，请移步【主体管理-编辑】完善其它！', {icon: 6});
				        			layer.close(ecmStepWindowId);
			        			} else {
				        			layer.msg('创建成功，请编辑完善其它信息！', {icon: 6});
				        			goPage('index');
			        			}
			        		}
			        	}
			        });	
			    } 
			});
		}

		//监听加载状态改变
		document.onreadystatechange = completeLoading;
		
		//加载状态为complete时移除loading效果
		function completeLoading() {
		  if (document.readyState == "complete") {
				$('.fixed-loading').addClass('hide');
				
		  }
		}
		
		$(document).ready(function(){
		    /*$(document).bind("contextmenu",function(e){
		        return false;
		    });*/
		});
	</script>
	
	
	

</body>

</html>